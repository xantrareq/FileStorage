{% extends "filemanager/base.html" %} 
{% load static %}
{% block title %}–ú–æ–∏ —Ñ–∞–π–ª—ã{% endblock %}

{% block content %}
    <h2>–í–∞—à –î–∏—Å–∫</h2>
    <div class="breadcrumbs" style="margin-bottom: 15px;">
        <a href="{% url 'my_files' %}">–ö–æ—Ä–Ω–µ–≤–∞—è –ø–∞–ø–∫–∞</a> / 
        {% for dir in breadcrumbs %}
            <a href="{% url 'my_files_in_dir' dir.id %}">{{ dir.name }}</a> / 
        {% endfor %}
    </div>

    <form method="get" style="margin-bottom: 20px;">
        <input type="text" name="q" placeholder="–ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫..." value="{{ search_query|default:'' }}" style="width: 70%; padding: 8px;">
        <button type="submit">–ù–∞–π—Ç–∏</button>
        {% if current_directory %}
            <input type="hidden" name="directory_id" value="{{ current_directory.id }}">
        {% endif %}
    </form>
    
    <div style="margin-bottom: 20px;">
        <button id="showUploadFormBtn" class="action-button">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
        
        <a href="{% url 'create_directory' %}{% if current_directory %}?parent_id={{ current_directory.id }}{% endif %}" 
            class="action-button" 
            style="background-color: #FFD700; color: #000; padding: 5px 5px; border: none; cursor: pointer; text-decoration: none; display: inline-block; border-radius: 5px; font-family: sans-serif;">
            –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É
        </a>

        <div id="uploadFormContainer" style="
            border: 1px solid #ccc; 
            padding: 20px; 
            margin-top: 15px; 
            background-color: #f9f9f9; 
            display: none; /* –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º */
        ">
            <h3>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –≤ –ø–∞–ø–∫—É "{% if current_directory %}{{ current_directory.name }}{% else %}–ö–æ—Ä–Ω–µ–≤–∞—è –ø–∞–ø–∫–∞{% endif %}"</h3>
            
            <form method="post" action="{% url 'upload_file' %}" enctype="multipart/form-data">
                {% csrf_token %}
                
                {{ upload_form.as_p }} {% if current_directory %}
                    <input type="hidden" name="directory_id" value="{{ current_directory.id }}">
                {% endif %}

                <button type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                <button type="button" id="hideUploadFormBtn">–û—Ç–º–µ–Ω–∞</button>
            </form>
        </div>
    </div>
    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
    <thead>
        <tr style="background-color: var(--color-primary);">
            <th style="padding: 10px; border: 1px solid #ccc; text-align: left;">–ò–º—è</th>
            <th style="padding: 10px; border: 1px solid #ccc; text-align: left;">–¢–∏–ø</th>
            <th style="padding: 10px; border: 1px solid #ccc; text-align: left;">–î–∞—Ç–∞</th>
            <th style="padding: 10px; border: 1px solid #ccc; text-align: center;">–î–µ–π—Å—Ç–≤–∏—è</th>
            <th style="padding: 10px; border: 1px solid #ccc; text-align: center;">–û–±—â–∏–π –¥–æ—Å—Ç—É–ø</th>
        </tr>
    </thead>
    <tbody>
        {% for item in page_obj %}
            <tr style="background-color: {% cycle 'white' '#fffbf0' %};">
                <td style="padding: 10px; border: 1px solid #eee;">
                    {% if item.name %} 
                        <span style="color: #FFD700;">üìÅ</span> 
                        <a href="{% url 'my_files_in_dir' item.id %}" style="font-weight: bold;">{{ item.name }}</a>
                    {% else %}
                        <span style="color: #888;">üìÑ</span> 
                        {{ item.filename }}
                    {% endif %}
                </td>
                
                <td style="padding: 10px; border: 1px solid #eee;">
                    {% if item.name %} –ü–∞–ø–∫–∞ {% else %} –§–∞–π–ª {% endif %}
                </td>
                
                <td style="padding: 10px; border: 1px solid #eee;">
                    {% if item.name %} 
                        {{ item.created_at|date:"d.m.Y H:i" }} 
                    {% else %} 
                        {{ item.upload_date|date:"d.m.Y H:i" }} 
                    {% endif %}
                </td>
                
                <td style="padding: 10px; border: 1px solid #eee; text-align: center;">
                    {% if item.name %}
                        <a href="{% url 'delete_directory' item.id %}" style="color: red; text-decoration: none;">–£–¥–∞–ª–∏—Ç—å</a>
                    {% else %}
                        <a href="{% url 'download_file' item.id %}" style="color: green; text-decoration: none;">–°–∫–∞—á–∞—Ç—å</a> |
                        <a href="{% url 'delete_file' item.id %}" style="color: red; text-decoration: none;">–£–¥–∞–ª–∏—Ç—å</a>
                    {% endif %}
                </td>

                <td style="padding: 10px; border: 1px solid #eee; text-align: left;">
    {% if not item.name %}
        
        <a href="{% url 'toggle_share' item.id %}" 
            style="padding: 3px 6px; border-radius: 4px; text-decoration: none; font-size: 11px; display: inline-block; background-color: {% if item.is_shared %}#ffc107; color: #000;{% else %}#007bff; color: white;{% endif %};"
        >
            {% if item.is_shared %}üö∑ –û—Ç–∫–ª—é—á–∏—Ç—å{% else %}üåê –ü–æ–¥–µ–ª–∏—Ç—å—Å—è{% endif %}
        </a>
        
       {% if item.is_shared and item.share_token %}
    
    {% url 'public_download' token=item.share_token as share_link %}
    
    {% with host_and_scheme=request.scheme|add:'://'|add:request.get_host %}
        
        <div style="margin-top: 5px; background-color: #f0f8ff; border: 1px solid #cce5ff; padding: 3px; border-radius: 4px;">
            
            <strong style="font-size: 10px;">–ê–∫—Ç–∏–≤–Ω–∞ –¥–æ: 
                <span class="local-time-display" 
                      data-timestamp="{{ item.share_expires_at|date:'U' }}">
                    {{ item.share_expires_at|date:"d.m.Y H:i" }} 
                </span>
            </strong>
            
            <div style="font-size: 10px; margin-top: 3px; word-break: break-all; display: flex; align-items: center;">
                
                <input type="text" value="{{ host_and_scheme }}{{ share_link }}" 
                    id="share-link-{{ item.id }}" 
                    readonly 
                    style="flex-grow: 1; border: 1px solid #ddd; padding: 2px; background-color: white; font-family: monospace; font-size: 10px; overflow: hidden; text-overflow: ellipsis;"
                >
                
                <button 
                    onclick="copyShareLink('share-link-{{ item.id }}')"
                    style="margin-left: 5px; padding: 3px 6px; font-size: 10px; background-color: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer; white-space: nowrap;"
                >
                    üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
            
        </div>
    {% endwith %}
{% endif %}
        
    {% endif %}
</td>
                
            </tr>
        {% empty %}
            <tr><td colspan="5">–ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞ –∏–ª–∏ –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</td></tr>
        {% endfor %}
    </tbody>
</table>

    <script>
        // ... (–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π JS –¥–ª—è —Ñ–æ—Ä–º—ã –∑–∞–≥—Ä—É–∑–∫–∏) ...
        document.getElementById('showUploadFormBtn').onclick = function() {
             document.getElementById('uploadFormContainer').style.display = 'block';
         };
         document.getElementById('hideUploadFormBtn').onclick = function() {
             document.getElementById('uploadFormContainer').style.display = 'none';
         };

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø
        function copyShareLink(elementId) {
            const copyText = document.getElementById(elementId);
            copyText.select();
            copyText.setSelectionRange(0, 99999); // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
            document.execCommand("copy");
            alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!");
        }
        function convertUTCToLocalTime() {
        const timeElements = document.querySelectorAll('.local-time-display');

        timeElements.forEach(element => {
            const unixTimestampSeconds = element.dataset.timestamp;

            if (unixTimestampSeconds) {
                // 1. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–µ–∫—É–Ω–¥—ã –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ Date
                const date = new Date(unixTimestampSeconds * 1000);
                
                // 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–ø—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const options = { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    hour12: false // –ò—Å–ø–æ–ª—å–∑—É–µ–º 24-—á–∞—Å–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç
                };
                
                // 3. –ò—Å–ø–æ–ª—å–∑—É–µ–º Intl.DateTimeFormat –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –∞–¥–∞–ø—Ç–∞—Ü–∏–∏
                try {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º ru-RU –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç—ã (DD.MM.YYYY)
                    const localTimeString = new Intl.DateTimeFormat('ru-RU', options).format(date);
                    element.textContent = localTimeString;
                } catch (e) {
                    // –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, –µ—Å–ª–∏ Intl –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
                    element.textContent = date.toLocaleString('ru-RU', options);
                }
            }
        });
    }
    </script>
    
{% endblock %}

